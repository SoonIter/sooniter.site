---
title: å‰ç«¯ monorepo ä¹‹æ®‡
description: å‰ç«¯ monorepo å­˜åœ¨å“ªäº›é—®é¢˜ï¼Œæ€ä¹ˆç®¡ç†å‰ç«¯ monorepo ï¼Ÿ
date: 2023-04-06
lang: zh
duration: 30min
image: frontend-monorepo/pnpm.png
---

åœ¨ç»„é‡Œè´Ÿè´£ monorepo æ²»ç†å·¥å…·ï¼Œæ¥åæ§½ä¸€ä¸‹å‰ç«¯ monorepo çš„ç°çŠ¶

## ä¸ºä»€ä¹ˆä½¿ç”¨ monorepo ?

[Why use a monorepo? - Youtube - Vercel](https://www.youtube.com/watch?v=flbz_5aMikw)

è¿™ä¸ªè§†é¢‘è¡¨ç°äº†ç°åœ¨å¤§å¤šæ•°äººç”¨ monorepo çš„çˆ½ç‚¹, å³å¯ä»¥ä¸èµ° "å‘åŒ…" æµç¨‹ æ¥ä»¥ "åŒ…" ä¸ºå•ä½æ¥å¤ç”¨ä»£ç 

æŒ‰ä¹‹å‰çš„å·¥ä½œæµ, åŒæ—¶å¼€å‘å¤šä¸ªåŒ…

1. ä¿®æ”¹ `@hello/a@1.0.0` çš„ä»£ç 

2. å‘å¸ƒ `@hello/a@1.0.1` æ–°åŒ…

3. `@hello/b` é¡¹ç›®ä¸­å®‰è£…æ–°ç‰ˆæœ¬çš„ A

ç°åœ¨çš„å·¥ä½œæµï¼Œä¿®æ”¹ `@hello/a` çš„ä»£ç åï¼Œå¯ä»¥ç«‹å³åé¦ˆåˆ°å¼€å‘ `@hello/b` ä¸Š

ä½†ä¸ºäº†è¿™ä¸ªçˆ½ç‚¹, è¦ä»˜å‡ºå¤šå°‘ä»£ä»·?

## è¿ç¯æ„å»º å’Œ ä¾èµ–æ‹“æ‰‘

å¯¹æ¯” Rust ä¸€ä¸ª `cargo build` è§£å†³ä¸€åˆ‡, JavaScript éœ€è¦å„ç§é¢„ç¼–è¯‘æ‰‹æ®µ, æ¯”å¦‚å¤„ç† typescript, jsx, css ç­‰, å„å®¶éƒ½æœ‰å„å®¶çš„å¤„ç†æ–¹æ³•, ç›´æ¥åˆ†å‘ ts æºç ä¸å†å¯èƒ½. è¿™å¯¼è‡´, æ¯ä¸ªåŒ…éƒ½æœ‰ç‹¬ç«‹çš„æ„å»ºæ‰‹æ®µ, ç”Ÿæˆä¸ª `dist` ç›®å½•ä»€ä¹ˆçš„, é€šå¸¸å†™åœ¨ `npm run build`.

äºæ˜¯éœ€è¦ä¸“é—¨çš„å·¥å…·æ¥å¸®æˆ‘ä»¬å¤„ç† å¤šä¸ªåŒ…è¿è¡Œ `npm run build` çš„é¡ºåº

> PS: è§£é‡Šæ€§è¯­è¨€éœ€è¦ç¼–è¯‘, ç¼–è¯‘å‹è¯­è¨€åˆ†å‘æºç , è¿™æ˜¯ä¸æ˜¯æœ‰ä¸€ç‚¹åŒå‘å¥”èµ´äº†?

ä»¥è¯¥é¡¹ç›®ä¸º ğŸŒ°

- ç›®å½•ç»“æ„

```txt
â”œâ”€â”€ apps
â”‚   â”œâ”€â”€ web1
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ web2
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ package.json
â”œâ”€â”€ packages
â”‚   â”œâ”€â”€ component
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ util
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ .npmrc
â””â”€â”€ pnpm-workspace.yaml
```

- ä¾èµ–å…³ç³»

```txt
  web1 -> component -> util
  web2 ->
```

monorepo å·¥å…·æ¯”å¦‚ `pnpm run` å’Œ `moon run` éœ€é€šè¿‡åˆ†æ `package.json`, ç®—å‡ºä¸€ä¸ªæœ‰å‘æ— ç¯å›¾, å³æ‹“æœ´ä¾èµ–, ä¿è¯ task è¿è¡Œé¡ºåºæ­£ç¡®

<img w-300px src="/imgs/frontend-monorepo/project-topo-graph.png"/>

```txt
util:build --> component:build --> web1:build --> (web1:test,e2e...)
```

`pnpm run` åˆ°è¿™é‡Œå°±ç»“æŸäº†, è¿™æ—¶è‹¥å†å¯åŠ¨ `web2:build`, monorepo å·¥å…·ä¼šå¤ç”¨ç¼“å­˜çš„ç»“æœ

```txt
util:build(cached) -> component:build(cached) -> web2:build
```

## äº§ç‰©å¼•å…¥ å’Œ æºç å¼•å…¥

build æ‹–ç€è¿™æ¡åˆè‡­åˆé•¿çš„é“¾è·¯è¿˜ç®—å‹‰å¼ºå¯ä»¥æ¥å—, start ä¹Ÿè¦æ·±å—å…¶ç´¯

```txt
  web1 -> component -> util
```

åœ¨ monorepo ä¸‹å¼€å‘æ­¤é¡¹ç›®, ä½ è¦ç»å†å¦‚ä¸‹

1. **å¤šå¼€ start**, éœ€æ‰‹åŠ¨æŒ‰é¡ºåºå¼€å¯ `util:start` `component:start` `web1:start`

2. **èµ„æºå¤„ç†**, æŠŠ less css ç­‰èµ„æºæ”¾è¿› js ä¸­å¯ä»¥, ä½†ä¸­é—´å“ªä¸ªåŒ…æ”¾è¿›å»äº†, æƒ³å†æ‹¿å‡ºæ¥å°±å¾ˆéš¾äº†

3. **hmr ææ…¢**, è‹¥ä¿®æ”¹ util çš„æºç  -> util æ„å»ºæ–°çš„äº§ç‰© -> component ç›‘å¬åˆ°æºç æ”¹å˜ -> component æ„å»ºæ–°çš„äº§ç‰© -> web1 ç›‘å¬åˆ°æºç æ”¹å˜ -> web1 æ„å»ºæ–°çš„äº§ç‰©, ä¸€é¡¿è¿ç¯ä¸‹æ¥, ææ…¢çš„ hmr å¾€å¾€éš¾ä»¥å¿å—

4. **å¤æ‚åº¦ "é«˜åˆ°æŒ‚"**, ä¾‹å¦‚

åœ¨ 3 ä¸­çš„ä¾‹å­é‡Œ, å¢åŠ ä¸€æ¡ä¾èµ–, è®© web1 åˆä¾èµ– util

```txt
  web1 -> component -> util
       -> util
```

`æ­¤æ—¶è‹¥æ›´æ”¹ util æºç ` --> `web1 å’Œ component æ›´æ–°` --> `web1 ç›‘å¬åˆ° component æ›´æ–°åˆè¯¥æ›´æ–°`

å¹¶å‘å¤šä¸ª hmr çš„é€Ÿåº¦ä¼šéšç€ä¾èµ–æ‹“æœ´çš„å¤æ‚ç¨‹åº¦å¢åŠ , èºæ—‹ä¸‹æ»‘, ç”šè‡³ä¼šç®—ä¸æ˜ç™½è€Œæ— å“åº”ç”šè‡³æŒ‚æ‰

è§£å†³æ–¹æ¡ˆå°±æ˜¯å¼•å…¥æºç è€Œä¸æ˜¯ä¸Šè¿°çš„å¼•å…¥äº§ç‰©, éœ€è¦ web1 æœ‰ä¸€ä¸ªå¼ºå¤§çš„ bundler, åƒ cargo ä¸€æ ·ç»Ÿä¸€æ„å»º web1, component, util çš„æ‰€æœ‰ ts æºç 

å¹¶ä¸”ä¸‹æ¸¸ä¸»åŠ¨é…åˆç»Ÿä¸€æ„å»ºç¯å¢ƒ, æ¯”å¦‚ jsx è¯­æ³•, ä¸è¦ä¸€ä¸ªä½¿ç”¨ React ä¸€ä¸ªä½¿ç”¨ Preact åŠå…¶ä»–ç±»ä¼¼çš„ç¼–è¯‘é­”æ³•

å¼•å…¥æºç , å®é™…ä¸Šæ˜¯æœ‰ç‚¹ magic çš„, ä¿®æ”¹ bundler çš„ resolve é€»è¾‘, è®© resolve æ‰“åˆ°æºç å³å¯

- å¼€å¯æ–¹å¼ 1 ç”¨ mainFields å¼€å¯

```js
module.exports = {
  // ...
  resolve: {
    mainFields: ['my-dev', 'jsnext:main', 'module', 'main'],
  },
};
```

```json
{
  "name": "util",
  "main": "dist/index.js",
  "my-dev": "src/index.ts"
  // æˆ–ç”¨ "jsnext:main": "src/index.ts"
  // ...
}
```

exports å­—æ®µåŒä¸Š, å¯è§ [Vite æ–‡æ¡£ resolve-conditions](https://vitejs.dev/config/shared-options.html#resolve-conditions)

- å¼€å¯æ–¹å¼ 2 ç”¨ resolve.alias è°ƒ

```js
module.exports = {
  alias: {
    '@xxxx/util': path.resolve(__dirname, '../../packages/util/src/index.ts'),
  },
};
```

> æ³¨æ„æ¡†æ¶å¯èƒ½ç”±äºæ€§èƒ½, loader é»˜è®¤å¿½ç•¥ node_modules, æ¯”å¦‚ nextjs éœ€å¼€å¯

```js
// next.config.js
/**
 * @type {import('next').NextConfig}
 */
module.exports = {
  transpilePackages: ['@xxx/util', 'åŒ…å'],
  // ...
};
```

ä¹‹åå¼€å‘åªå¼€å¯ä¸€ä¸ª start å³å¯, ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾

1. é«˜åº¦ä¸€è‡´çš„æ„å»ºç¯å¢ƒ

2. æ”¶æ•›è‡ªå®šä¹‰æ„å»ºè¡Œä¸º, ä¸­é—´åŒ…æƒ³åœ¨ç¼–è¯‘æ—¶åšç‚¹äº‹æƒ…, æ¯”å¦‚æ›¿æ¢æ‰ `process.env.NODE__ENV` å‡ ä¹ä¸å¯èƒ½äº†

3. å¼€å‘ç”Ÿäº§çš„ä¸ä¸€è‡´, å‘åŒ…åçš„äº§ç‰©æŒ‚æ‰æµ‘ç„¶ä¸çŸ¥

4. ä¸ºä»€ä¹ˆä¸ç›´æ¥æ”¾å¼ƒ monorepo è€Œä½¿ç”¨æºç æ–‡ä»¶å¤¹å‘¢ ...

## é›†ä¸­å¼ä¾èµ–ç®¡ç†

pnpm, Cargo ä¸­çš„ `overrides` éƒ½è¦å†™åœ¨æ ¹ç›®å½•.

ç©¶å…¶åŸå› , æ˜¯ semver è§£æç­–ç•¥äº§ç”Ÿçš„å…¨å±€é™åˆ¶ä¸Šä¸‹æ–‡, global constrain context

ä¸ºäº†ä¾¿äºç†è§£, æˆ‘ä»¬å¯ä»¥æŠ½è±¡ä¸€ä¸‹, è®¤ä¸ºåœ¨ monorepo ä¸­å®‰è£…ä¾èµ–å’Œ å•åŒ… ä¸‹å®‰è£…ä¾èµ–ä¸€æ ·çš„, ç»™ä¸€æ•´ä¸ª monorepo å®‰è£…ä¾èµ–, ç›¸å½“äºç»™ä¸€æ•´ä¸ªå¤§åŒ…å®‰è£…ä¾èµ–.

çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­

æˆ‘ä»¬é¦–å…ˆæœ‰ä¸€ä¸ª a åŒ…

```json
// a/package.json
{
  "name": "a",
  "dependencies": {
    "react": "^18.2.0"
  }
}
```

å®‰è£…å `a>react@18.2.0>loose-envify@1.4.0>js-token@4.0.0`, å¦‚æœè¿™ä¸ªæ˜¯ä¸ª monorepo, å†æ¥ä¸ªå¦‚ä¸‹çš„ b åŒ…, å®ƒä¼šå¤ç”¨ react@18.2.0

```json
// b/package.json
{
  "name": "b",
  "dependencies": {
    "react": "^18.1.0"
  }
}
```

```yaml
# pnpm-lock.yaml (ç®€åŒ–å)
libs/a:
  specifiers:
    react: ^18.2.0
  dependencies:
    react: 18.2.0

libs/b:
  specifiers:
    react: ^18.1.0
  dependencies:
    react: 18.2.0

/js-tokens/4.0.0:
  dev: false

/loose-envify/1.4.0:
  dependencies:
    js-tokens: 4.0.0

/react/18.2.0:
  dependencies:
    loose-envify: 1.4.0
```

ç”Ÿæˆçš„ç»“æ„

```bash
# a å’Œ b ä½¿ç”¨ç›¸åŒçš„ react@18.2.0
a > react@18.2.0 > loose-envify@1.4.0 > js-tokens@4.0.0
b /
```

è‹¥ b è¿™æ¡é“¾è·¯ä¸Šä½†å‡¡ä¸åŒä¸€ç‚¹, éƒ½ä¸èƒ½å«åš "åŒä¸€ä»½ react"

```bash
# å¦‚æœè¿™æ¡é“¾è·¯ä¸Šæœ‰ä¸€ç‚¹ä¸ç›¸åŒ, a å’Œ b å®é™…ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ª React
a > react@18.2.0 > loose-envify@1.4.0 > js-tokens@4.0.0
b > react@18.2.0 > loose-envify@1.4.0 > js-tokens@5.0.0
```

åœ¨è¿™ç§æƒ…å†µä¸‹, æ—¢å¯ä»¥å‡å°‘éœ€è¦å®‰è£…çš„ä¾èµ–, åˆå¯ä»¥ä½¿ç”¨åŒä¸€ä»½ react,

æ‰€ä»¥ç»™ a å’Œ b å½¢æˆçš„ monorepo å®‰è£…ä¾èµ–,ä½ å¯ä»¥è¿‘ä¼¼ç†è§£ä¸ºç»™ä»¥ä¸‹çš„ c å•åŒ…å®‰è£…ä¾èµ–

> PS: æ³¨æ„æ˜¯è¿‘ä¼¼å“ˆï¼Œä¸ºäº†ä¾¿äºç†è§£

```json
// è™šæ‹Ÿ c åŒ…/package.json
{
  "name": "c",
  "dependencies": {
    "react": "^18.2.0" // å–ä¸ª "^18.2.0" å’Œ "^18.1.0" éƒ½æ»¡è¶³çš„å€¼
  }
}
```

### monorepo + semver === 'å¯„'

ä¸Šè¿°æƒ…å†µåªæ˜¯æœ€ç†æƒ³æƒ…å†µ, ä¸‹é¢å±•ç¤ºä¸€ä¸‹å¸¦æ¥çš„é—®é¢˜, å‡è®¾ monorepo ä¸­

```txt
a ä¾èµ– "react": "<=18.2.0"
b ä¾èµ– "react": ">=18.1.0"
```

å¼€å‘è€…æ ¹æ®çš„æ˜¯ ä»¥ä¸‹çš„è™šæ‹Ÿ c åŒ…æ¥å®‰è£…ä¾èµ–

```txt
è™šæ‹Ÿ c ä¾èµ– "react": ">=18.1.0 && <=18.2.0"
```

å¼€å‘è€…ä¸‹åˆ°çš„ç‰ˆæœ¬æ˜¯ `"react": "18.2.0"`, çœ‹ä¼¼éå¸¸åˆç†å¯¹ä¸å¯¹ ?

ä½†åœ¨båŒ…çš„ç”¨æˆ·è§’åº¦æ¥çœ‹, å´åƒäº†ç˜ª

båŒ…ç”¨æˆ·ä¸‹è½½åˆ° b æ ¹æ® semver `">=18.1.0"` ä¸‹åˆ°äº†æœ€æ–° latest çš„ `react@18.11.0` ç›´æ¥æŒ‚äº†

> "æˆ‘æ“¦, ä½ å†™çš„ >=18.1.0 èƒŒåœ°é‡Œè‡ªå·±ç”¨çš„æ˜¯ >=18.1.0 && <=18.2.0, è€å­ç”¨çš„æ˜¯ 18.11.0, ç›´æ¥æŒ‚äº†"

è¿™ä¸ªé—®é¢˜åŒæ ·å‡ºç°åœ¨ Cargo, ç”¨æˆ·ä½¿ç”¨ swc æ—¶ å°±éš¾ä»¥ç»´æŠ¤ swc è¿™äº›åŒ…çš„å†…éƒ¨å…³ç³», æ‰€ä»¥å°½é‡åªå¼•å…¥ `swc_core` è¿™ä¸€ä¸ªåŒ…, ç‰¹æ€§ç”± features å¼€å…³.

ä½†è¯åˆè¯´å›æ¥, ä½ è™½ç„¶ä»¥ monorepo å¼€å‘, ä½†åªæš´éœ²ä¸€ä¸ªåŒ…ä½œä¸ºå…¥å£, æ˜¯ä¸æ˜¯å’Œå•ä»“æ²¡æœ‰åŒºåˆ«äº† ?

## è‡­åæ˜­è‘—çš„ æ‰¾ä¸åˆ°åŒ… -- Cannot found module "xxx"

### å¹»å½±ä¾èµ–

ç”±äº npm å°†æ‰€æœ‰ä¾èµ– hoist åˆ° node_modules, node é€çº§å‘ä¸ŠæŸ¥æ‰¾ node_modules æ—¶å¯ä»¥æ‰¾åˆ°æœªå£°æ˜åˆ° `package.json` ä¸­çš„ä¾èµ–, é€ æˆå¼€å‘å¯ç”¨ä½†å‘åŒ…åæŠ¥ `Cannot found module "xxx"`

è§£å†³æ–¹æ³•æ˜¯ç”¨ åŒ…ç®¡ç†å™¨ç»™çš„åé—¨,æ¯”å¦‚ pnpm çš„ `overrides` `packageExtensions` `hook.readPackage`, ä¿®å¤ä¸‰æ–¹åŒ…æ¼å†™çš„,å†™é”™çš„ `package.json`

ä¸” pnpm é‡‡ç”¨äº† .pnpm + hardlink + symlink, æ¥é™åˆ¶é¡¶å±‚ hoist çš„è¡Œä¸º, ç®—æ˜¯å·²ç»è¾ƒå¥½åœ°è§£å†³, å¯¹å¼€å‘è´¨é‡æœ‰è¿½æ±‚çš„å¼€å‘è€…å·²ç»ç€æ‰‹ä½¿ç”¨ ç±» pnpm çš„æ‰‹æ®µæ¥æ²»ç† hoist

ä½†é€ æˆ `Cannot found module` çš„, ç»å¯¹ä¸æ­¢ `shamefully-hoist` ä¸€ä¸ª

### devDependencies é€ æˆçš„å¹»å½±ä¾èµ–

å¼€å‘ç¯å¢ƒä¸‹ï¼Œ`devDeps` å’Œ `deps` ä¼šè¢«æ— å·®åˆ«åœ°ä¸‹è½½åˆ° `node_modules` ä¸­, å¼€å‘æ—¶å¯ä»¥ä¸æŠ¥é”™åœ° import devDependencies, è€Œå‘åŒ…åç”±äºåªå®‰è£… `deps` ä¸å®‰è£… `devDependencies` ä¾ç„¶å¯ä»¥é€ æˆ `Cannot found module "xxx"`

monorepo ä¸­æ— ç–‘å°†è¿™ä¸ªé—®é¢˜æ”¾å¤§äº†, å†™ `"@xxx/util": "workspace:*"` æ˜æ˜å¯ç”¨, æ”¹æˆ `"@xxx/util": "1.1.0"` å°±ä¸å¯ç”¨äº†,

å’Œä¸Šä¸€æ¡æºç å¼•å…¥ä¸€æ ·, monorepo ä¼š`æ”¾å¤§å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´çš„é—®é¢˜`, æˆ‘ä»¬ä½¿ç”¨ monorepo ä¸­çš„ "åŒ…", ä½†æˆ‘ä»¬å·²ç»è¶…è¿‡äº† "åŒ…" æ‰€èƒ½è§¦ç¢°åˆ°çš„èŒƒå›´, è¿™ä¸€é—®é¢˜åœ¨ä¸‹ä¸€æ¡æ›´åŠ æ˜æ˜¾

### å¤šå®ä¾‹é—®é¢˜ï¼Œä»¥åŠ monorepo ä¸­çš„ dedupe

æˆ‘ç›¸ä¿¡ä½ åœ¨ monorepo é‡Œå¿…å®šé‡åˆ°è¿‡ react å¤šå®ä¾‹é—®é¢˜

ä»¥è¯¥é¡¹ç›®ä¸ºä¾‹ï¼šweb å’Œ component å‡ä¾èµ– `react@^18`ï¼Œç”±äºä¸€äº›åŸå› ä¸‹è½½åˆ°äº†ä¸åŒçš„ react ç‰ˆæœ¬ã€‚

```txt
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ .npmrc
â”œâ”€â”€ apps
â”‚   â””â”€â”€ web
â”‚       â”œâ”€â”€ node_modules
â”‚       â”‚   â””â”€â”€ react@18.2.0
â”‚       â””â”€â”€ package.json
â””â”€â”€ packages
    â””â”€â”€ component
        â”œâ”€â”€ node_modules
        â”‚   â””â”€â”€ react@18.1.0
        â””â”€â”€ package.json
```

ç”±äº node resolve é€çº§å‘ä¸ŠæŸ¥æ‰¾çš„ç‰¹æ€§ï¼Œå½“ web å¼•å…¥ component çš„æ—¶å€™ï¼Œweb é‡Œçš„æºç  resolve çš„æ˜¯ `react@18.2.0`ï¼Œcomponent çš„æºç  resolve çš„æ˜¯ `react@18.1.0`ï¼Œå…¨å±€äº§ç”Ÿäº†å¤šä¸ª React å®ä¾‹

è¿™é€ æˆäº†è‡´å‘½æ€§çš„é—®é¢˜

1. å¯¹äº `React`ï¼Œ`React-dom`, `React-router`ï¼Œ`Redux` è¿™ç§å…¨å±€å•ä¾‹çš„åŒ…æ„å»ºæˆåŠŸï¼Œä½†ä¼šäº§ç”Ÿè¿è¡Œæ—¶é”™è¯¯

2. é‡å¤æ‰“åŒ…å¢å¤§åŒ…ä½“ï¼Œè€Œä¸”ä¸æ­¢é‡å¤æ‰“ä¸€ä¸ªï¼Œæ˜¯æ‰“ä¸€æ•´æ¡é“¾è·¯ï¼Œ`react@18.2.0>loose-envify@1.4.0>js-tokens@5.0.0` å’Œ `react@18.1.0>loose-envify@1.3.0>js-tokens@4.0.0`

å¹¶ä¸”è¿™ç§æƒ…å†µä¸‹ `component` çš„ `package.json` æ˜¯å¦å†™å¯¹éƒ½æ²¡æœ‰ç”¨ï¼Œå†™è¿› `deps` `devDeps` è¿˜æ˜¯ `peerDeps`, åœ¨å¼€å‘ç¯å¢ƒä¸‹è¡¨ç°éƒ½æ˜¯ä¸€æ ·çš„

è¿™åœ¨å•ä»“ä¸‹æ˜¯ä¸å¸¸é‡åˆ°ï¼Œå› ä¸º web ä¸‹è½½ componentï¼Œå¤šåŠä¼šç”±äº semverï¼Œ`react@^18` è§£æåˆ°åŒä¸€ä¸ªç‰ˆæœ¬ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ `peerDeps` æ¥ä¿è¯ç»„ä»¶åº“å’Œ app ä¾èµ–åˆ°åŒä¸€ä»½ react

#### ä¸€åŒ…ä¸€ç‰ˆæœ¬ â€”â€” å¾ˆå¤šè¯­è¨€

è®¸å¤šè¯­è¨€é‡‡ç”¨çš„æ˜¯**ä¸€åŒ…ä¸€ç‰ˆæœ¬**çš„ä¾èµ–, åœ¨ä½  semver ç‰ˆæœ¬å†²çªæ—¶ï¼Œä¼šç›´æ¥è®©ä½ ä¸å®‰è¿™ä¸ªä¾èµ–

è¿™ä¸ª a åŒ…ï¼Œä¾èµ– `xxx@1.1.x`ï¼Œå½“å¼•å…¥ b åŒ… ä¾èµ– `xxx@1.2.x`ï¼Œè¿™æ—¶ç›´æ¥æŠ¥ resolve errorï¼Œå…¨å±€åªå…è®¸å­˜åœ¨ä¸€ä»½

è¿™æ ·å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œå¯¹äºä¸‰æ–¹ä¾èµ–ç‰ˆæœ¬å·çš„è¦æ±‚è¶Šæ¥è¶Šè‹›åˆ»ã€‚

#### ä¸€åŒ…å¤šç‰ˆæœ¬ â€”â€” node_modules

node ä¸‹çš„åŒ…ç®¡ç†ï¼Œå…è®¸ä¸€ä¸ªåŒ…å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œæ¯”å¦‚ `debug@5.0.0` `debug@4.0.0` å¯ä»¥å…±å­˜ï¼Œä½†`react@18` å’Œ `react@17` å®é™…æ˜¯ä¸å¯ä»¥å…±å­˜çš„å•Šï¼Œäºæ˜¯å°±å¸¦æ¥äº†å¼€å¤´çš„é—®é¢˜ã€‚

ç”šè‡³ä¼šæœ‰ `react@17` å’Œ `react@18` é¡¹ç›® åŒå¤„äºä¸€ä¸ª monorepoä¸‹é€ æˆè®¸å¤šé—®é¢˜ã€‚

#### è§£å†³æ–¹æ³• â€”â€” monorepoä¸­çš„ dedupe

å»é™¤é‡å¤åŒ…ï¼Œå°½é‡é è¿‘ **ä¸€åŒ…ä¸€ç‰ˆæœ¬**

ä¾‹å¦‚ï¼šä½¿ç”¨ `pnpm dedupe` æ¥å‡å°‘é‡å¤ä¾èµ–ï¼Œ`component -> react@^18.1.0` å’Œ `app -> react@^18.2.0`ï¼Œå°±åº”è¯¥åªå®‰è£…ä¸€ä»½ï¼Œä½†å¸¦æ¥çš„é—®é¢˜æ˜¯ monorepo ä¸­å„åŒ…éš”ç¦»æ€§å‡å¼±

æˆ–è€… ç¼–è¯‘æ—¶ hack resolveï¼Œæ‰‹åŠ¨æŒ‡å‘åŒä¸€ä»½ react

```js
// webpack.config.js
module.exports = {
  resolve: {
    alias: {
      react: path.join(__dirname, 'node_modules/react'),
    },
  },
};
```

è¿™ä¸ª hack ç”±äºç”¨çš„å¤ªå¤šï¼Œvite ç”šè‡³ç›´æ¥æ”¯æŒäº†ä¸€ä¸ª `dedupe` å­—æ®µ ![Vite å®˜æ–¹æ–‡æ¡£ â€”â€” resolve-dedupe](https://vitejs.dev/config/shared-options.html#resolve-dedupe)

ä½†è¿˜æœ‰å¾ˆå¤šåœºæ™¯ï¼Œæ— æ³•æ‰‹åŠ¨æŒ‡å®š resolveï¼Œæ‰€ä»¥æˆ‘å¾ˆç†è§£ yarn ä¸ºä»€ä¹ˆè¦åš pnp æ¨¡å¼ï¼Œæˆ–è®¸ pnp æ‰æ˜¯æœªæ¥ monorepo çš„æ ‡é…

## ç‰ˆæœ¬å·ç®¡ç†

å¯èƒ½ä½ ä¼šè¯´, æˆ‘çš„å‘åŒ…å¯ä»¥ä¸¥å®ˆ semver è§„èŒƒ, æ¯ä¸ªå¤§ç‰ˆæœ¬å’Œå°ç‰ˆæœ¬éƒ½æŒ‰è§„çŸ©æå‡ç‰ˆæœ¬å·ï¼Œæ˜¯ä¸æ˜¯é—®é¢˜å°±å¾ˆå°‘äº†ï¼Œé‚£ä½ ä¸€å®šä¸çŸ¥é“åœ¨ monorepo ä¸‹ç®¡ç†ç‰ˆæœ¬å·æœ‰å¤šè´¹åŠ²

### changeset

monorepo é‡Œ changeset çš„åˆ›æ„éå¸¸å¥½ï¼Œæˆ‘ä¿®æ”¹å“ªä¸ªåŒ…å°±å¢åŠ æŸä¸ªåŒ…çš„ changesetï¼Œ`add-changeset` æ¥å­˜å‚¨æ¯ä¸ª commit çš„æ›´æ–°æ„å›¾ã€‚ç­‰åˆ° `bump` å’Œ å‘åŒ…æ—¶ï¼Œå†æ ¹æ®ä¾èµ–æ‹“æ‰‘ï¼Œæ›´æ”¹ä¸Šæ¸¸çš„åŒ…ï¼Œæ¥åŒæ­¥æœ€æ–°ç‰ˆæœ¬ã€‚

ä½†é—®é¢˜éšä¹‹è€Œæ¥ï¼Œå°±æ˜¯ monorepo ä¸­çš„æ‰€æœ‰åŒ…ï¼Œç‰ˆæœ¬å·å‚å·®ä¸é½ã€‚

ä¸€ä¸ª a åŒ…æ˜¯ `@1.3.1`ï¼Œb åŒ…å¯èƒ½æ˜¯ `@2.0.0`ï¼Œc åŒ…å¯èƒ½æ˜¯ `@4.0.0`

å¼€å‘è€…ç”¨çš„è¿˜å¥½ï¼Œç”¨æˆ·ç›´æ¥åˆåƒç˜ª

ä½¿ç”¨äº† `@xxx/a@1.3.1` çš„ç”¨æˆ·ï¼Œæƒ³å†å®‰ä¸€ä¸ª `@xxx/b`ï¼Œä½†é€‰ç‰ˆæœ¬å·çš„æ—¶å€™çŠ¯äº†éš¾ï¼Œè¿™äº›åŒ…çœ‹ä¼¼åœ¨ä¸€ä¸ª scope ä¸‹ï¼Œç‰ˆæœ¬å´æ¯«æ— å…³è”ã€‚

ä½ ä¹Ÿä¸æƒ³ä½¿ç”¨ `react@18` å†å¼•ä¸€ä¸ª `@types/react@19` å§

ç»´æŠ¤å¤šä¸ªåŒ…ï¼Œç»ˆç©¶è¿˜æ˜¯å¤æ‚çš„ã€‚

### fixed-packages linked-packages å’Œ bumpp

é‚£ï¼Œè®© monorepo çš„åŒ…ä½¿ç”¨åŒä¸€ç‰ˆæœ¬å·ï¼Œç”¨æˆ·ç”¨ `react@18.2.0` è‡ªç„¶è”æƒ³åˆ°è¦è£…ç›¸åŒç‰ˆæœ¬çš„ `react-dom@18.2.0` ä¸å°±å¥½äº†ã€‚

changeset æä¾›äº† [fixed](https://github.com/changesets/changesets/blob/main/docs/fixed-packages.md) å’Œ [linked](https://github.com/changesets/changesets/blob/main/docs/linked-packages.md) ä¸¤ç§æ¨¡å¼ä¾›ç”¨æˆ·é€‰æ‹©ã€‚

antfu çš„ bumpp åˆ™ç›´æ¥å…¨ä»“åº“ `bump patch/minor/major` æ¥æ›´æ–°ç‰ˆæœ¬å·

ç¼ºç‚¹æ˜¾è€Œæ˜“è§ï¼Œæˆ‘çš„åŒ…ç‰ˆæœ¬ä¸éµå¾ª semver è§„èŒƒäº†

<!-- ## CI

### build ä¸‹æ¸¸ï¼Œtest ä¸Šæ¸¸

ç»™ monorepo æ‰¾å›ä¸€äº›å°Šä¸¥ï¼Œé‚£å°±æ˜¯ -->

æ€»ç»“ï¼Œmonorepo ä¼šè®©å¼€å‘è€…çˆ½ï¼Œä½†ä¹Ÿåªèƒ½çˆ½ä¸€åŠï¼Œè¿˜ä¼šè®©ç”¨æˆ·ä¸çˆ½ã€‚

ç”±äºä»¥ä¸Šé—®é¢˜, æˆ‘ä»¬é‡æ–°æ€è€ƒ, ä»¥ "åŒ…" ä¸ºå•ä½å¤ç”¨ä»£ç çš„ monorepo , å¸¦æ¥çš„è¿™ä¸ªå¤æ‚åº¦æ˜¯å¦å€¼å¾—

pnpm ä½œè€…æ‰€åœ¨çš„å…¬å¸å¼€å‘äº† [Bit](https://bit.dev/) , å·²ç»ä¸ä»¥ "åŒ…" ä¸ºå•ä½åˆ†å‘ä»£ç , è€Œæ˜¯ä»¥ "ç»„ä»¶" ä¸ºå•ä½, ç»„ç»‡æ–¹å¼ä¹Ÿæ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æºç æ–‡ä»¶å¤¹,ä¸è¿‡å¢åŠ äº†æ–‡ä»¶ç»“æ„çš„çº¦æŸ, æ— éœ€å†™ç¹é‡çš„ package.json ï¼Œå…·ä½“æ˜¯å¦å¥½ç”¨è¿˜è¦ç”±æ—¶é—´å»æ£€éªŒ

## å‚è€ƒ

- [1][ç°ä»£å‰ç«¯å·¥ç¨‹ä¸ºä»€ä¹ˆè¶Šæ¥è¶Šç¦»ä¸å¼€ Monorepo?](https://juejin.cn/post/6944877410827370504)
- [2][Cargo Book â€”â€” Dependency Resolution](https://rustwiki.org/en/cargo/reference/resolver.html#dependency-resolution)
- [3][Vite æ–‡æ¡£ â€”â€” resolve-dedupe](https://vitejs.dev/config/shared-options.html#resolve-dedupe)
